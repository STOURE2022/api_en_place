# üìã ANALYSE DE COUVERTURE - Features Gherkin vs Code Actuel

## üéØ Vue d'Ensemble

Ce document analyse la couverture des sp√©cifications Gherkin par le code actuel et identifie les fonctionnalit√©s manquantes.

---

## ‚úÖ FEATURES IMPL√âMENT√âES (Couverture Actuelle)

### 1. Background - Structure Standard des Tables ‚úÖ

**Spec:**
```gherkin
Given the standard format for OUTPUT_DATE is "yyyy-MM-dd HH:mm:ss"
And the first four columns in all output Delta Tables are:
| FILE_LINE_ID | FILE_NAME_RECEIVED | FILE_EXTRACTION_DATE | FILE_PROCESS_DATE |
```

**Impl√©mentation:**
- ‚úÖ `src/delta_manager.py` - Ajoute les 4 colonnes techniques
- ‚úÖ `src/config.py` - Format date "yyyy-MM-dd HH:mm:ss"
- ‚úÖ Colonnes ajout√©es automatiquement √† chaque table

**Fichiers:**
```python
# delta_manager.py
extended_fields = [
    StructField("FILE_LINE_ID", LongType(), False),
    StructField("FILE_NAME_RECEIVED", StringType(), False),
    StructField("FILE_EXTRACTION_DATE", TimestampType(), False),
    StructField("FILE_PROCESS_DATE", TimestampType(), False)
]
```

---

### 2. Module 1 : D√©zipage ‚úÖ

**Spec:**
```gherkin
Scenario: Zipped file received
Given a file is received
And the file is a zip archive
When the file is processed
Then the file is unzipped
And the extracted files are copied to the raw destination folder
```

**Impl√©mentation:**
- ‚úÖ `src/unzip_module.py` - Extraction ZIP compl√®te
- ‚úÖ Organisation par table
- ‚úÖ Suppression ZIP apr√®s extraction (modifi√©)

**√âtat:** COMPLET

---

### 3. Validation Filename Pattern ‚úÖ

**Spec:**
```gherkin
Rule: Check the name of the File received regarding the Filename Pattern
Scenario: Validity of the date extracted from the filename
Given the "<file_date>" extracted from the filename
When the "<file_date>" is not a "<valid_date>"
Then Reject the file, Raise an error
```

**Impl√©mentation:**
- ‚úÖ `src/validator.py` - validate_filename()
- ‚úÖ Extraction date depuis filename
- ‚úÖ Validation pattern

**√âtat:** COMPLET

---

### 4. Modes d'Ingestion ‚úÖ

**Spec:**
```gherkin
Scenario: FULL_SNAPSHOT mode creates/updates Last and All tables
Scenario: DELTA_FROM_FLOW mode updates All table only
```

**Impl√©mentation:**
- ‚úÖ `src/ingestion.py` - 5 modes disponibles:
  - FULL_SNAPSHOT
  - DELTA_FROM_FLOW
  - DELTA_FROM_NON_HISTORIZED
  - DELTA_FROM_HISTORIZED
  - FULL_KEY_REPLACE

**√âtat:** COMPLET (m√™me plus que demand√©)

---

### 5. Validation Colonnes ‚úÖ

**Spec:**
```gherkin
Given the number of columns resulting from file parsing
When a discrepancy is detected
Then Reject the file
```

**Impl√©mentation:**
- ‚úÖ `src/validator.py` - validate_columns_presence()
- ‚úÖ V√©rification pr√©sence colonnes
- ‚úÖ V√©rification types

**√âtat:** COMPLET

---

### 6. Gestion des Dates ‚úÖ

**Spec:**
```gherkin
Rule: Control the Date in input and Format the dates in Output
Given The "<date_in_input>" and the "<transformation_pattern_date>"
When the format matches
Then the "<output_date>" should be "yyyy-MM-dd HH:mm:ss"
```

**Impl√©mentation:**
- ‚úÖ `src/column_processor.py` - _apply_date_conversion()
- ‚úÖ Patterns multiples support√©s
- ‚úÖ Format output standardis√©

**√âtat:** COMPLET

---

### 7. Error Action (ICT_DRIVEN, REJECT, LOG_ONLY) ‚úÖ

**Spec:**
```gherkin
Rule: Error Action Rule
When ICT_DRIVEN -> Increment ICT number
When REJECT -> Reject the line
When LOG_ONLY -> The data will not be rejected
```

**Impl√©mentation:**
- ‚úÖ `src/column_processor.py` - apply_error_action()
- ‚úÖ 3 modes support√©s
- ‚úÖ Gestion erreurs par ligne

**√âtat:** COMPLET

---

### 8. ICT (Invalid Column per Line Tolerance) ‚úÖ

**Spec:**
```gherkin
Rule: ICT Rule
Given compute the ICT = ICT number / total number of columns
When ICT >= threshold
Then Reject the line
```

**Impl√©mentation:**
- ‚úÖ `src/column_processor.py` - Calcul ICT
- ‚úÖ Comparaison avec seuil
- ‚úÖ Rejet si d√©passement

**√âtat:** COMPLET

---

### 9. RLT (Rejected Line per File Tolerance) ‚úÖ

**Spec:**
```gherkin
Rule: RLT Rule
Given compute the RLT = rejected lines / total lines
When RLT >= threshold
Then the file is rejected
```

**Impl√©mentation:**
- ‚úÖ `src/validator.py` - check_rlt_threshold()
- ‚úÖ Calcul RLT
- ‚úÖ Rejet fichier si seuil d√©pass√©

**√âtat:** COMPLET

---

### 10. Partitionnement ‚úÖ

**Spec:**
```gherkin
Rule: Manage partitioning columns
Given PARTITION_BY = "yyyy/mm/dd"
Then add technical columns for partitioning
```

**Impl√©mentation:**
- ‚úÖ `src/delta_manager.py` - Partitionnement yyyy/mm/dd
- ‚úÖ Colonnes techniques ajout√©es automatiquement

**√âtat:** COMPLET

---

### 11. Nullable Constraints ‚úÖ

**Spec:**
```gherkin
Given the configuration specifies NOT Nullable
When the column value is NULL
Then apply the Error Action Rule
```

**Impl√©mentation:**
- ‚úÖ `src/validator.py` - validate_nullable_constraints()
- ‚úÖ V√©rification nullabilit√©
- ‚úÖ Application Error Action

**√âtat:** COMPLET

---

### 12. Logging et M√©triques ‚úÖ

**Spec:**
```gherkin
Scenario: writes the final execution report with all metrics
Given each file in input
Then write the execution report
```

**Impl√©mentation:**
- ‚úÖ `src/logger_manager.py` - Logs complets
- ‚úÖ M√©triques d√©taill√©es
- ‚úÖ Tables de logs (execution + quality)

**√âtat:** COMPLET

---

## ‚ö†Ô∏è FEATURES PARTIELLEMENT IMPL√âMENT√âES

### 1. Fail Fast Option ‚ö†Ô∏è

**Spec:**
```gherkin
Rule: Fail Fast Option
Given error percentage threshold
When percentage of errors >= threshold
Then stop ingestion immediately
```

**√âtat Actuel:**
- ‚ö†Ô∏è Logique pr√©sente dans column_processor
- ‚ö†Ô∏è Mais pas expos√©e comme param√®tre configurable
- ‚ö†Ô∏è Pas de seuil global au niveau fichier

**√Ä Faire:**
- Ajouter param√®tre `fail_fast_threshold` dans config
- Impl√©menter arr√™t imm√©diat
- Documenter

---

### 2. Invalid Lines Generated Table ‚ö†Ô∏è

**Spec:**
```gherkin
Rule: Invalid Lines Generate Rule
When Invalid lines generated is true
Then keep all invalid lines in a Table
```

**√âtat Actuel:**
- ‚ö†Ô∏è Logs des erreurs existants
- ‚ö†Ô∏è Mais pas de table d√©di√©e pour lignes invalides
- ‚ö†Ô∏è Bad records dans `/bad_records/` mais pas en table

**√Ä Faire:**
- Cr√©er table `<table_name>_invalid_lines`
- Sauvegarder lignes rejet√©es
- Ajouter param√®tre `invalid_lines_generated`

---

### 3. INPUT_HEADER Options ‚ö†Ô∏è

**Spec:**
```gherkin
Rule: Capability to manage the Name of the Columns
When INPUT_HEADER is empty -> use config column names
When INPUT_HEADER is FIRST_LINE -> skip first line
When INPUT_HEADER is HEADER_USE -> use file header names
```

**√âtat Actuel:**
- ‚ö†Ô∏è Option header support√©e par Auto Loader
- ‚ö†Ô∏è Mais pas les 3 modes distincts
- ‚ö†Ô∏è Pas de gestion HEADER_USE

**√Ä Faire:**
- Impl√©menter 3 modes INPUT_HEADER
- G√©rer HEADER_USE
- Documenter

---

### 4. Transformation Regex ‚ö†Ô∏è

**Spec:**
```gherkin
Scenario: transformation type is regex
Given transformation pattern = regex
Then apply regex to column
```

**√âtat Actuel:**
- ‚ö†Ô∏è Structure pr√©sente dans column_processor
- ‚ö†Ô∏è Mais impl√©mentation regex incompl√®te
- ‚ö†Ô∏è Pas test√©e

**√Ä Faire:**
- Compl√©ter impl√©mentation regex
- Ajouter tests
- Documenter patterns support√©s

---

### 5. Enrich Type (filename-modified) ‚ö†Ô∏è

**Spec:**
```gherkin
Scenario: Enrich type is filename-modified
Then create column by extracting from filename
```

**√âtat Actuel:**
- ‚ö†Ô∏è Extraction date depuis filename OK
- ‚ö†Ô∏è Mais pas d'enrichissement g√©n√©rique
- ‚ö†Ô∏è Pas de colonne technique filename

**√Ä Faire:**
- Ajouter colonne source_filename
- Impl√©menter enrich_type
- Documenter

---

## ‚ùå FEATURES NON IMPL√âMENT√âES

### 1. Non-Zipped File Handling ‚ùå

**Spec:**
```gherkin
Scenario: Non-zipped file received
Given file is not a zip archive
Then file is copied to raw destination
```

**√âtat Actuel:**
- ‚ùå Uniquement ZIP support√©
- ‚ùå Fichiers CSV directs non g√©r√©s

**√Ä Impl√©menter:**
- D√©tecter fichiers non-ZIP
- Copier vers `/extracted/`
- Traiter comme fichiers extraits

**Priorit√©:** HAUTE (requis R1)

---

### 2. Prevent Duplicate File Processing ‚ùå

**Spec:**
```gherkin
Scenario: prevent the processing of the same file
Given file name received and all filenames ingested
When file name exists in ingested
Then Reject the file
```

**√âtat Actuel:**
- ‚ùå Pas de v√©rification fichiers d√©j√† trait√©s
- ‚ùå Pas de tracking des fichiers ing√©r√©s

**√Ä Impl√©menter:**
- Table tracking: `wax_processed_files`
- V√©rification avant traitement
- Error code 000000002

**Priorit√©:** HAUTE (requis R1)

---

### 3. File Order Validation ‚ùå

**Spec:**
```gherkin
Scenario: prevent processing of old file
Given date in filename and previous date
When date < previous date
Then Reject file
```

**√âtat Actuel:**
- ‚ùå Pas de v√©rification ordre chronologique
- ‚ùå Pas de tracking derni√®re date

**√Ä Impl√©menter:**
- Stocker derni√®re date trait√©e par table
- Valider ordre chronologique
- Error code 000000003

**Priorit√©:** MOYENNE

---

### 4. Last Table vs All Table ‚ùå

**Spec:**
```gherkin
Rule: Names of Delta Table Name
Scenario: FULL_SNAPSHOT creates Last and All tables
Then create "<table_name>_last" and "<table_name>_all"
```

**√âtat Actuel:**
- ‚ùå Une seule table cr√©√©e
- ‚ùå Pas de distinction _last / _all

**√Ä Impl√©menter:**
- Cr√©er 2 tables distinctes
- `_last`: derni√®res donn√©es
- `_all`: historique complet
- G√©rer selon mode ingestion

**Priorit√©:** HAUTE (requis R1)

---

### 5. Custom Last Table Name ‚ùå

**Spec:**
```gherkin
Scenario: Name of Last Delta Table is customized
Given "<last_table_name_conf>"
When not Empty
Then name is "<last_table_name_conf>"
```

**√âtat Actuel:**
- ‚ùå Pas de param√®tre last_table_name
- ‚ùå Nom table non customizable

**√Ä Impl√©menter:**
- Ajouter param√®tre `last_table_name`
- Supporter noms personnalis√©s
- Fallback sur `<table>_last`

**Priorit√©:** BASSE

---

### 6. Partitioning with Time Components ‚ùå

**Spec:**
```gherkin
Examples:
| partitioning        | columns          |
| yyyy/mm/dd/hhmmss   | yyyy,mm,dd,hhmmss|
```

**√âtat Actuel:**
- ‚ùå Seulement yyyy/mm/dd support√©
- ‚ùå Pas de partitionnement heure/min/sec

**√Ä Impl√©menter:**
- Support yyyy/mm/dd/hhmmss
- Colonnes hhmmss
- Configuration flexible

**Priorit√©:** BASSE

---

### 7. Comment Metadata on Columns ‚ùå

**Spec:**
```gherkin
Rule: Functional description to the column
Given Comment of the column
When Comment is not empty
Then add Comment in metadata
```

**√âtat Actuel:**
- ‚ùå Pas d'ajout de commentaires
- ‚ùå M√©tadonn√©es colonnes non g√©r√©es

**√Ä Impl√©menter:**
- Lire colonne Comment depuis Excel
- Ajouter via Delta Table API
- Documenter colonnes

**Priorit√©:** BASSE

---

### 8. Multi-Format Support (JSON, Parquet, XML) ‚ùå

**Spec:**
```gherkin
Scenario: Ingestion tool flexible for other formats
(json, parquet, xml)
```

**√âtat Actuel:**
- ‚ùå Seulement CSV support√©
- ‚ùå Pas de JSON, Parquet, XML

**√Ä Impl√©menter:**
- Support multi-formats
- D√©tection automatique format
- Configuration input_format

**Priorit√©:** BASSE (pas R1)

---

### 9. Numeric Harmonization ‚ùå

**Spec:**
```gherkin
Scenario: Harmonization of dates and numeric
```

**√âtat Actuel:**
- ‚úÖ Dates harmonis√©es
- ‚ùå Numeric pas harmonis√©s
- ‚ùå Pas de gestion d√©cimales

**√Ä Impl√©menter:**
- Gestion s√©parateurs d√©cimaux
- Conversion formats num√©riques
- Standardisation

**Priorit√©:** MOYENNE

---

### 10. File Recovery & Late Ingestion ‚ùå

**Spec:**
```gherkin
@not-in-release1
Scenario: File recovery
Scenario: Late file ingestion
```

**√âtat Actuel:**
- ‚ùå Pas de recovery automatique
- ‚ùå Pas de late files

**√Ä Impl√©menter:**
- Mode recovery pour fichiers manqu√©s
- Gestion late arrivals
- M√©canisme rattrapage

**Priorit√©:** BASSE (hors R1)

---

## üìä R√âCAPITULATIF

```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë  COUVERTURE DES SP√âCIFICATIONS                           ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  ‚úÖ Impl√©ment√©           : 12 features (48%)             ‚ïë
‚ïë  ‚ö†Ô∏è  Partiel              :  5 features (20%)             ‚ïë
‚ïë  ‚ùå Non impl√©ment√©        :  10 features (32%)            ‚ïë
‚ïë  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ   ‚ïë
‚ïë  TOTAL                   : 27 features (100%)            ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
```

---

## üéØ PRIORIT√âS POUR R1

### PRIORIT√â HAUTE (Requis R1)

1. **Non-Zipped File Handling** ‚ùå
   - Fichiers CSV directs
   - Impact: Utilisabilit√©
   
2. **Prevent Duplicate Processing** ‚ùå
   - Table tracking
   - Impact: Int√©grit√© donn√©es

3. **Last Table vs All Table** ‚ùå
   - Deux tables distinctes
   - Impact: Architecture donn√©es

4. **Fail Fast Option** ‚ö†Ô∏è
   - Param√®tre configurable
   - Impact: Performance

5. **Invalid Lines Table** ‚ö†Ô∏è
   - Table lignes invalides
   - Impact: Qualit√©/Debug

### PRIORIT√â MOYENNE

6. **File Order Validation** ‚ùå
7. **INPUT_HEADER Modes** ‚ö†Ô∏è
8. **Numeric Harmonization** ‚ùå

### PRIORIT√â BASSE

9. **Transformation Regex** ‚ö†Ô∏è
10. **Enrich Type** ‚ö†Ô∏è
11. **Custom Last Table Name** ‚ùå
12. **Partitioning Time** ‚ùå
13. **Comment Metadata** ‚ùå

### HORS R1

14. **Multi-Format Support** ‚ùå
15. **File Recovery** ‚ùå
16. **Late Ingestion** ‚ùå

---

## üìù PROCHAINES √âTAPES

### Phase 1 : Combler les Gaps R1 (1-2 semaines)

1. Impl√©menter Non-Zipped File Handling
2. Cr√©er syst√®me Duplicate Prevention
3. Impl√©menter Last/All Tables
4. Exposer Fail Fast Option
5. Cr√©er Invalid Lines Table

### Phase 2 : Compl√©ter Partiel (1 semaine)

6. Finaliser INPUT_HEADER modes
7. Compl√©ter Transformation Regex
8. Impl√©menter Enrich Type

### Phase 3 : Features Moyennes (1 semaine)

9. File Order Validation
10. Numeric Harmonization

### Phase 4 : Features Basses (optionnel)

11. Custom table names
12. Partitioning avanc√©
13. Comment metadata

---

## üí° RECOMMANDATIONS

### Architecture

- ‚úÖ Cr√©er `tracking_manager.py` pour duplicate/order
- ‚úÖ √âtendre `ingestion.py` pour Last/All tables
- ‚úÖ Ajouter `invalid_lines_table` dans delta_manager

### Configuration

- ‚úÖ Ajouter param√®tres manquants dans Excel
- ‚úÖ Documenter nouveaux param√®tres
- ‚úÖ Tests pour chaque feature

### Tests

- ‚úÖ Tests unitaires pour nouvelles features
- ‚úÖ Tests d'int√©gration End-to-End
- ‚úÖ Tests BDD avec Behave (optionnel)

---

## üìö FICHIERS √Ä CR√âER/MODIFIER

### Nouveaux Fichiers

```
src/
‚îú‚îÄ‚îÄ tracking_manager.py        # Duplicate + Order validation
‚îú‚îÄ‚îÄ invalid_lines_manager.py   # Gestion lignes invalides
‚îî‚îÄ‚îÄ file_handler.py            # Non-ZIP files
```

### Fichiers √† Modifier

```
src/
‚îú‚îÄ‚îÄ config.py                  # Nouveaux param√®tres
‚îú‚îÄ‚îÄ ingestion.py               # Last/All tables
‚îú‚îÄ‚îÄ delta_manager.py           # Invalid lines table
‚îú‚îÄ‚îÄ column_processor.py        # Regex, enrich
‚îú‚îÄ‚îÄ validator.py               # File order
‚îî‚îÄ‚îÄ main.py                    # Orchestration
```

### Documentation

```
docs/
‚îú‚îÄ‚îÄ FEATURES_COVERAGE.md       # Ce fichier
‚îú‚îÄ‚îÄ IMPLEMENTATION_GUIDE.md    # Guide impl√©mentation
‚îî‚îÄ‚îÄ TESTING_STRATEGY.md        # Strat√©gie tests
```

---

‚úÖ **Document cr√©√© pour guider l'impl√©mentation des features manquantes**
